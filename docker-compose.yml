version: "3.8"

services:
  php:
    image: php:7.4-fpm
    container_name: jas_php
    volumes:
      - .:/var/www/html
    working_dir: /var/www/html
    entrypoint: >
      sh -c "
         apt-get update &&
         apt-get install -y git unzip &&
         docker-php-ext-install mysqli pdo pdo_mysql &&
         if [ ! -f /var/www/html/index.php ]; then
           git clone https://github.com/Gek11/pphp-main.git /tmp/app &&
           cp -r /tmp/app/* /var/www/html/ &&
           rm -rf /tmp/app;
         fi &&
         php-fpm
      "

  nginx:
    image: nginx:latest
    container_name: jas_nginx
    ports:
      - "8080:80"
    volumes:
      - .:/var/www/html
    depends_on:
      - php
    entrypoint: >
      sh -c '
        echo "
        server {
            listen 80;
            server_name localhost;

            root /var/www/html;
            index index.php index.html;

            location / {
                try_files \$uri \$uri/ =404;
            }

            location ~ \.php\$ {
                include fastcgi_params;
                fastcgi_pass php:9000;
                fastcgi_index index.php;
                fastcgi_param SCRIPT_FILENAME /var/www/html\$fastcgi_script_name;
            }
        }
        " > /etc/nginx/conf.d/default.conf &&
        nginx -g \"daemon off;\"
      '
